# HTTP3

HTTP1和HTTP2 共同的问题，应用层问题

## 一 http3之前面临的问题

### 1 tcp对头阻塞

因为应用层都依赖与tcp，tcp的可靠性，导致只要有数据包的丢失（丢包），就会一直等待丢失的数据包，滑动窗口不会滑动，造成tcp对头阻塞问题。

**在 TCP 传输过程中，由于单个数据包的丢失而造成的阻塞称为 TCP 上的队头阻塞。**

如下图：

![](https://static001.geekbang.org/resource/image/33/96/33d2b4c14a7a2f19ef6677696b67de96.png)

![](https://static001.geekbang.org/resource/image/48/d1/4837434655a6d87f1bf5e3d899a698d1.png)

Http1.1还好点，因为有6个tcp连接，而http2.0 由于只有一个tcp连接，多个请求都在一个tcp连接，其中**任意一路数据流中出现了丢包的情况，那么就会阻塞该 TCP 连接中的所有请求**



### 2 TCP 建立连接的延时

- tcp三次握手往返时延为 ：1.5RTT
- https TLS连接，大致需要 1~2个RTT（版本不同，时延不同）

总共，需要花掉3~4个RTT，如果1个RTT要100ms，整个握手过程就会让用户感到慢了



### 二 http3的改进

由于TCP协议的僵化，改进tcp一不太可能

- 中间设备的僵化
  - 如果在客户端升级了 TCP 协议，当新协议的数据包经过这些中间设备，它们可能不理解包的内容，于是这些数据就会被丢弃掉。
  - 它是阻碍 TCP 更新的一大障碍。
- 操作系统也是导致 TCP 协议僵化的另外一个原因
  - TCP 协议都是通过操作系统内核来实现的，应用程序只能使用不能修改
  - 通常操作系统的更新都滞后于软件的更新，因此要想自由地更新内核中的 TCP 协议也是非常困难的



### QUIC协议

基于 UDP 实现了类似于 TCP 的多路数据流、传输可靠性等功能，我们把这套功能称为 QUIC 协议。

###### <img src="https://static001.geekbang.org/resource/image/0b/c6/0bae470bb49747b9a59f9f4bb496a9c6.png" style="zoom: 50%;" />

- 实现了类似 TCP 的流量控制、传输可靠性的功能。
- 集成了 TLS 加密功能
  - 相较于早期版本 TLS1.3 有更多的优点，其中最重要的一点是减少了握手所花费的 RTT 个数
- 实现了 HTTP/2 中的多路复用功能
  - QUIC 实现了在同一物理连接上可以有多个独立的逻辑数据流（如下图）。
  - 实现了数据流的单独传输，就解决了 TCP 中队头阻塞的问题。
- 实现了快速握手功能。由于 QUIC 是基于 UDP 的，所以 QUIC 可以实现使用 0-RTT 或者 1-RTT 来建立连接，

![](https://static001.geekbang.org/resource/image/05/9a/05cc5720989aec75730ee4cb7e7c149a.png)

